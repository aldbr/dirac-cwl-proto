$namespaces:
  dirac: ../../../schemas/dirac-metadata.json#/$defs/
$schemas:
  - ../../../schemas/dirac-metadata.json
hints:
- class: dirac:inputDataset
  event_type: '90000000'
  conditions_dict:
    inTCKs: ALL
    inProPass: Real Data/Reco17/Stripping29r2p2
    configName: LHCb
    inFileType: CHARM.MDST
    configVersion: Collision17
    inProductionID: ALL
    inDataQualityFlag: OK
  launch_parameters:
    end_run:
    start_run:
    run_numbers:
  conditions_description: Beam6500GeV-VeloClosed-MagUp

id: AnaProd_lc2pkpidcs_2018_MagDown_collision_LbToLcpkpi
class: Workflow
label: AnaProd#lc2pkpidcs#2018_MagDown_collision_LbToLcpkpi
doc: |-
  LHCb Analysis Production Workflow: AnaProd#lc2pkpidcs#2018_MagDown_collision_LbToLcpkpi

  Metadata:
    Input Dataset:
      Event Type: 90000000
      Processing Pass: Real Data/Reco18/Stripping34r0p2
      File Type: CHARM.MDST
      Config: LHCb/Collision18
      Conditions: Beam6500GeV-VeloClosed-MagDown

  This workflow contains 2 transformation(s).

  Generated by ProductionRequestToCWL converter
inputs:
- id: production-id
  doc: Production ID
  default: 12345
  type: int
- id: prod-job-id
  doc: Production Job ID
  default: 6789
  type: int
- id: input-data
  doc: Input data files from Bookkeeping query
  type: File[]
outputs:
- id: output-data
  label: Output Data
  outputSource: transformation_2/output-data
  type: File[]
- id: others
  label: Logs and summaries
  outputSource: transformation_2/others
  type:
    type: array
    items:
    - File
    - 'null'
requirements:
- class: InlineJavascriptRequirement
- class: SubworkflowFeatureRequirement
- class: StepInputExpressionRequirement
- class: MultipleInputFeatureRequirement
- class: ResourceRequirement
  coresMin: 1
  ramMin: 2048
cwlVersion: v1.2
steps:
- id: transformation_1
  in:
  - id: input-data
    source: input-data
  - id: production-id
    source: production-id
  - id: prod-job-id
    source: prod-job-id
  out:
  - id: output-data
  - id: others
  run:
    id: transformation_1
    class: Workflow
    label: Transformation 1
    doc: "Transformation 1: WGProduction\nContains 1 step(s)"
    inputs:
    - id: production-id
      doc: Production ID
      default: 12345
      type: int
    - id: prod-job-id
      doc: Production Job ID
      default: 6789
      type: int
    - id: input-data
      doc: Input data files from Bookkeeping query
      type: File[]
    outputs:
    - id: output-data
      outputSource:
      - AnaProd_v1r4500_2018_MagDown_collision_LbToLcpkpi/output-data
      linkMerge: merge_flattened
      type: File[]
    - id: others
      outputSource:
      - AnaProd_v1r4500_2018_MagDown_collision_LbToLcpkpi/others
      linkMerge: merge_flattened
      type:
        type: array
        items:
        - File
        - 'null'
    requirements:
    - class: InlineJavascriptRequirement
    - class: StepInputExpressionRequirement
    - class: MultipleInputFeatureRequirement
    hints:
    - class: dirac:TransformationExecutionHooks
      group_size: 2
      configuration:
        cpu: '1000000'
        priority: 2
        multicore: true
        output_se: CERN-BUFFER
        output_mode: Local
        input_plugin: APProcessing
        ancestor_depth: 0
        output_file_mask: ''
        input_data_policy: protocol
        remove_inputs_flags: false
        events: -1
      hook_plugin: WGProduction
    cwlVersion: v1.2
    steps:
    - id: AnaProd_v1r4500_2018_MagDown_collision_LbToLcpkpi
      in:
      - id: production-id
        source: production-id
      - id: prod-job-id
        source: prod-job-id
      - id: output-prefix
        source:
        - production-id
        - prod-job-id
        valueFrom: $(self[0].toString().padStart(8, "0"))_$(self[1].toString().padStart(8, "0"))_1
      out:
      - id: output-data
      - id: others
      run:
        id: AnaProd_v1r4500_2018_MagDown_collision_LbToLcpkpi_tool
        class: CommandLineTool
        inputs:
        - id: production-id
          type: int
          inputBinding:
            prefix: --production-id
        - id: prod-job-id
          type: int
          inputBinding:
            prefix: --prod-job-id
        - id: output-prefix
          type: string
          inputBinding:
            prefix: --output-prefix
        outputs:
        - id: output-data
          type: File[]
          outputBinding:
            glob: '*.root'
        - id: others
          type: File[]?
          outputBinding:
            glob: '*'
            outputEval: |-
              $(self.filter(function(f) { return !f.basename.endsWith('.root') && !f.basename.startsWith('prodConf') && !f.basename.startsWith('inputFiles') && !f.basename.endsWith('.json'); }))
        requirements:
        - class: InlineJavascriptRequirement
        - class: InitialWorkDirRequirement
          listing:
          - entryname: prodConf_1.json
            entry: |-
              {
                "application": {
                  "name": "DaVinci",
                  "version": "v44r11p6"
                },
                "step_id": 1,
                "step_name": "AnaProd#v1r4500#2018_MagDown_collision_LbToLcpkpi",
                "data_packages": [
                  {
                    "name": "AnalysisProductions",
                    "version": "v1r4500"
                  }
                ],
                "options": {
                  "files": [
                    "$ANALYSIS_PRODUCTIONS_DYNAMIC/lc2pkpidcs/2018_MagDown_collision_LbToLcpkpi_autoconf.py",
                    "$ANALYSIS_PRODUCTIONS_BASE/lc2pkpidcs/Lb_Lcpkpi.py"
                  ],
                  "format": "WGProd"
                },
                "processing_pass": "AnaProd-v1r4500-collision_LbToLcpkpi"
              }
        baseCommand:
        - lb-prod-run
        arguments:
        - --prodConf=prodConf_1.json
- id: transformation_2
  in:
  - id: input-data
    source: transformation_1/output-data
  - id: production-id
    source: production-id
  - id: prod-job-id
    source: prod-job-id
  out:
  - id: output-data
  - id: others
  run:
    id: transformation_2
    class: Workflow
    label: Transformation 2
    doc: "Transformation 2: APMerge\nContains 1 step(s)"
    inputs:
    - id: production-id
      doc: Production ID
      default: 12345
      type: int
    - id: prod-job-id
      doc: Production Job ID
      default: 6789
      type: int
    - id: input-data
      doc: Input data files from previous transformation
      type: File[]
    outputs:
    - id: output-data
      outputSource:
      - AnaProd_MergeV2_lc2pkpidcs_merge0/output-data
      linkMerge: merge_flattened
      type: File[]
    - id: others
      outputSource: []
      linkMerge: merge_flattened
      type:
        type: array
        items:
        - File
        - 'null'
    requirements:
    - class: InlineJavascriptRequirement
    - class: StepInputExpressionRequirement
    - class: MultipleInputFeatureRequirement
    hints:
    - class: dirac:TransformationExecutionHooks
      group_size: 10
      configuration:
        cpu: '1000000'
        priority: 2
        multicore: true
        output_se: CERN-ANAPROD
        output_mode: Local
        input_plugin: APProcessingByFileTypeSize
        ancestor_depth: 0
        output_file_mask: ''
        input_data_policy: protocol
        remove_inputs_flags: true
        events: -1
      hook_plugin: APMerge
    cwlVersion: v1.2
    steps:
    - id: AnaProd_MergeV2_lc2pkpidcs_merge0
      in:
      - id: production-id
        source: production-id
      - id: prod-job-id
        source: prod-job-id
      - id: output-prefix
        source:
        - production-id
        - prod-job-id
        valueFrom: $(self[0].toString().padStart(8, "0"))_$(self[1].toString().padStart(8, "0"))_2
      - id: input-files
        source: input-data
        valueFrom: |-
          ${{ var files = self.map(f => f.path).join('\n'); return {{ class: 'File', basename: 'inputFiles_2.txt', contents: files }}; }}
      out:
      - id: output-data
      - id: others
      run:
        id: AnaProd_MergeV2_lc2pkpidcs_merge0_tool
        class: CommandLineTool
        inputs:
        - id: production-id
          type: int
          inputBinding:
            prefix: --production-id
        - id: prod-job-id
          type: int
          inputBinding:
            prefix: --prod-job-id
        - id: output-prefix
          type: string
          inputBinding:
            prefix: --output-prefix
        - id: input-files
          type: string
          inputBinding:
            prefix: --input-files
        outputs:
        - id: output-data
          type: File[]
          outputBinding:
            glob: '*.root'
        - id: others
          type: File[]?
          outputBinding:
            glob: '*'
            outputEval: |-
              $(self.filter(function(f) { return !f.basename.endsWith('.root') && !f.basename.startsWith('prodConf') && !f.basename.startsWith('inputFiles') && !f.basename.endsWith('.json'); }))
        requirements:
        - class: InlineJavascriptRequirement
        - class: InitialWorkDirRequirement
          listing:
          - entryname: prodConf_2.json
            entry: |-
              {
                "application": {
                  "name": "lb-conda/default",
                  "version": "2025-07-31"
                },
                "step_id": 2,
                "step_name": "AnaProd#MergeV2#lc2pkpidcs#merge0",
                "options": {
                  "entrypoint": "LbExec:skim_and_merge",
                  "extra_args": [],
                  "extra_options": {
                    "compression": {
                      "level": 6,
                      "algorithm": "ZSTD",
                      "optimise_baskets": true
                    }
                  }
                },
                "processing_pass": "merged"
              }
        baseCommand:
        - lb-prod-run
        arguments:
        - --prodConf=prodConf_2.json
